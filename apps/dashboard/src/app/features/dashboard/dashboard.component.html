<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <app-create-task-modal
      #createTaskModal
      [visible]="isModalVisible"
      (formClose)="onModalClose()"
    ></app-create-task-modal>

    <!-- Mobile sidebar overlay -->
    @if (isSidebarOpen) {
    <div
      class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
      (click)="closeSidebar()"
      (keydown.escape)="closeSidebar()"
      tabindex="0"
      role="button"
      aria-label="Close sidebar"
    ></div>
    }

    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside
        class="sidebar-enterprise enterprise-gpu fixed lg:static inset-y-0 left-0 z-25 w-72 transform transition-transform duration-300 ease-in-out lg:translate-x-0"
        [class.translate-x-0]="isSidebarOpen"
        [class.-translate-x-full]="!isSidebarOpen"
        [class.lg:translate-x-0]="true"
      >
        <!-- Profile Section -->
        <div class="profile-enterprise">
          <button
            (click)="onProfileClick(); $event.stopPropagation()"
            class="flex items-center space-x-3 w-full transition-all duration-300"
          >
            <div class="relative">
              <div class="avatar-enterprise">
                {{
                  ((currentUser$ | async)?.username || 'U')
                    .charAt(0)
                    .toUpperCase()
                }}
              </div>
              <div
                class="absolute -bottom-1 -right-1 w-4 h-4 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full border-2 border-white dark:border-gray-800 floating shadow-lg"
              ></div>
            </div>
            <div class="flex-1 text-left">
              <p class="text-sm font-semibold text-gray-900 dark:text-white">
                {{ (currentUser$ | async)?.username || 'Loading...' }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 capitalize">
                {{ (currentUser$ | async)?.role || 'Loading...' }}
              </p>
            </div>
            <svg
              class="w-4 h-4 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-navigation">
          <div class="space-y-1">
            <!-- Dashboard -->
            <div
              class="nav-enterprise"
              [class.active]="isNavItemActive('dashboard')"
            >
              <button (click)="onNavItemClick('dashboard'); closeSidebar()">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-medium">Dashboard</span>
              </button>
            </div>

            <!-- My Tasks -->
            <div
              class="nav-enterprise"
              [class.active]="isNavItemActive('my-tasks')"
            >
              <button (click)="onNavItemClick('my-tasks'); closeSidebar()">
                <i data-lucide="check-square" class="w-5 h-5"></i>
                <span class="font-medium">My Tasks</span>
              </button>
            </div>

            <!-- Calendar -->
            <div
              class="nav-enterprise"
              [class.active]="isNavItemActive('calendar')"
            >
              <button (click)="onNavItemClick('calendar'); closeSidebar()">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span class="font-medium">Calendar</span>
              </button>
            </div>

            <!-- Departments -->
            <div
              class="nav-enterprise"
              [class.active]="isNavItemActive('departments')"
            >
              <button (click)="onNavItemClick('departments'); closeSidebar()">
                <i data-lucide="building" class="w-5 h-5"></i>
                <span class="font-medium">Departments</span>
              </button>
            </div>

            <!-- Members -->
            <div
              class="nav-enterprise"
              [class.active]="isNavItemActive('members')"
            >
              <button (click)="onNavItemClick('members'); closeSidebar()">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="font-medium">Members</span>
              </button>
            </div>

            <!-- Analytics (Only for Owners and Admins) -->
            @if (canAccessAnalytics(currentUser$ | async)) {
            <div
              class="nav-enterprise"
              [class.active]="isNavItemActive('analytics')"
            >
              <button (click)="onNavItemClick('analytics'); closeSidebar()">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span class="font-medium">Analytics</span>
              </button>
            </div>
            }
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden lg:ml-0">
        <!-- Header -->
        <header class="header-enterprise">
          <div class="px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between">
              <!-- Left Section: Mobile menu button and title -->
              <div class="flex items-center space-x-4 flex-1">
                <!-- Mobile menu button -->
                <button
                  (click)="toggleSidebar()"
                  class="hamburger-button-enterprise"
                  aria-label="Toggle navigation menu"
                >
                  <!-- Hamburger menu icon (3 horizontal lines) -->
                  <div
                    class="hamburger-enterprise"
                    [class.active]="isSidebarOpen"
                  >
                    <span class="hamburger-line-enterprise">-</span>
                    <span class="hamburger-line-enterprise">-</span>
                    <span class="hamburger-line-enterprise">-</span>
                  </div>
                </button>

                <!-- Page title for mobile -->
                <h1
                  class="text-lg font-semibold text-gray-900 dark:text-white lg:hidden"
                >
                  {{
                    activeNavItem === 'dashboard'
                      ? 'Dashboard'
                      : activeNavItem === 'my-tasks'
                      ? 'My Tasks'
                      : activeNavItem === 'calendar'
                      ? 'Calendar'
                      : activeNavItem === 'departments'
                      ? 'Departments'
                      : activeNavItem === 'members'
                      ? 'Members'
                      : activeNavItem === 'analytics'
                      ? 'Analytics'
                      : 'Dashboard'
                  }}
                </h1>

              </div>

              <!-- Center Section: Desktop New Task Button -->
              <div class="hidden lg:flex items-center justify-center mr-4">
                <button
                  (click)="onNewTaskClick()"
                  class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-8 py-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold"
                >
                  <i data-lucide="plus" class="w-5 h-5 mr-2 inline"></i>
                  New Task
                </button>
              </div>

              <!-- Right Section: Theme toggle and Mobile New Task Button -->
              <div class="flex items-center space-x-3">
                <!-- Theme toggle -->
                <div class="flex items-center">
                  <app-theme-toggle></app-theme-toggle>
                </div>

                <!-- Mobile New Task Button -->
                <button
                  (click)="onNewTaskClick()"
                  class="btn-enterprise-3d lg:hidden"
                  title="New Task"
                >
                  <span class="text-xl font-bold">+</span>
                  <!-- Pulse animation for mobile -->
                  <div
                    class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-400 to-purple-400 opacity-0 animate-ping"
                  ></div>
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Content Area -->
        <main
          class="main-enterprise flex-1 overflow-y-auto enterprise-scrollbar"
        >
          <div class="p-4 sm:p-6">
            <!-- Dashboard Content -->
            @if (activeNavItem === 'dashboard') {
            <div class="space-y-6">
              <!-- Statistics Charts Section -->
              <div class="grid grid-cols-1 gap-6">
                <!-- Tasks by Department Chart -->
                <div class="chart-enterprise enterprise-gpu">
                  <app-statistics-chart
                    [chartType]="'bar'"
                    [title]="'Tasks by Department'"
                    [dataType]="'department'"
                  >
                  </app-statistics-chart>
                </div>
              </div>

              <!-- Tasks Overview Section -->
              <div class="mb-8 shadow-lg rounded-lg p-6">
                <div class="flex items-center justify-between mb-6">
                  <h3
                    class="text-xl font-semibold text-gray-900 dark:text-white"
                  >
                    All the work tasks in the Organization
                  </h3>
                </div>

                <!-- Tasks Loading State -->
                @if (tasksLoading$ | async) {
                <div class="flex items-center justify-center p-8">
                  <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                  ></div>
                  <span class="ml-2 text-gray-600">Loading tasks...</span>
                </div>
                }

                <!-- Tasks Error State -->
                @if (tasksError$ | async; as error) {
                <div
                  class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4"
                >
                  <div class="flex items-center">
                    <i
                      data-lucide="alert-circle"
                      class="w-5 h-5 text-red-600 mr-2"
                    ></i>
                    <span class="text-red-800 dark:text-red-200"
                      >Error loading tasks: {{ error }}</span
                    >
                  </div>
                </div>
                }

                <!-- Tasks List -->
                @if ((tasksLoading$ | async) === false && (tasksError$ | async)
                === null) {
                <div class="space-y-4">
                  @for (task of tasks$ | async; track task.id) {
                  <div
                    class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 hover:shadow-md transition-all duration-200"
                    [class.cursor-pointer]="canEditTask(task)"
                    [class.hover:border-blue-300]="canEditTask(task)"
                    [class.dark:hover:border-blue-600]="canEditTask(task)"
                    (click)="onTaskClick(task)"
                    (keydown.enter)="onTaskClick(task)"
                    (keydown.space)="onTaskClick(task)"
                    [title]="
                      canEditTask(task)
                        ? 'Click to edit task'
                        : 'View only - Access required'
                    "
                    [attr.tabindex]="canEditTask(task) ? '0' : '-1'"
                    role="button"
                    [attr.aria-label]="
                      canEditTask(task)
                        ? 'Edit task: ' + task.title
                        : 'View task: ' + task.title
                    "
                  >
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <h4
                          class="font-medium text-gray-900 dark:text-white mb-1"
                        >
                          {{ task.title }}
                        </h4>
                        @if (task.description) {
                        <p
                          class="text-sm text-gray-600 dark:text-gray-400 mb-2"
                        >
                          {{ task.description }}
                        </p>
                        }
                        <div class="flex items-center gap-2 mb-2">
                          <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                            [class]="getPriorityClass(task.priority)"
                          >
                            {{ task.priority }}
                          </span>
                          <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                            [class]="getStatusClass(task.status)"
                          >
                            {{ task.status }}
                          </span>
                        </div>
                        <div
                          class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400"
                        >
                          @if (task.dueDate) {
                          <span
                            class="inline-flex items-center"
                            [class]="
                              isOverdue(task.dueDate)
                                ? 'text-red-600 dark:text-red-400 font-medium'
                                : 'text-gray-500 dark:text-gray-400'
                            "
                          >
                            <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
                            Due {{ task.dueDate | date: 'short' }}
                          </span>
                          }
                          <span class="text-gray-500 dark:text-gray-400">
                            Created {{ task.createdAt | date: 'short' }}
                          </span>
                          @if (task.department) {
                          <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                          >
                            {{ task.department }}
                          </span>
                          }
                        </div>
                      </div>
                      <div class="flex items-center gap-2">
                        @if (canEditTask(task)) {
                        <button
                          (click)="onTaskClick(task); $event.stopPropagation()"
                          class="p-2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                          title="Edit task"
                        >
                          <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        } @else {
                        <div
                          class="p-2 text-gray-300 dark:text-gray-600"
                          title="Access required"
                        >
                          <i data-lucide="lock" class="w-4 h-4"></i>
                        </div>
                        }
                      </div>
                    </div>
                  </div>
                  } @empty {
                  <div class="text-center py-8">
                    <i
                      data-lucide="clipboard-list"
                      class="w-12 h-12 text-gray-400 mx-auto mb-4"
                    ></i>
                    <h3
                      class="text-lg font-medium text-gray-900 dark:text-white mb-2"
                    >
                      No work tasks in the Organization
                    </h3>
                  </div>
                  }
                </div>
                }

                <!-- Pagination Controls -->
                @if (totalPages > 1) {
                <div
                  class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200 dark:border-gray-700"
                >
                  <!-- Page Info -->
                  <div class="text-sm text-gray-600 dark:text-gray-400">
                    Showing {{ (currentPage - 1) * pageSize + 1 }}-{{
                      Math.min(currentPage * pageSize, totalTasks)
                    }}
                    of {{ totalTasks }} tasks
                  </div>

                  <!-- Pagination Buttons -->
                  <div class="flex items-center space-x-2">
                    <!-- Previous Button -->
                    <button
                      (click)="goToPreviousPage()"
                      [disabled]="currentPage === 1"
                      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700"
                    >
                      Previous
                    </button>

                    <!-- Page Numbers -->
                    @for (page of getPageNumbers(); track page) {
                    <button
                      (click)="goToPage(page)"
                      [class]="
                        page === currentPage
                          ? 'px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md'
                          : 'px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700'
                      "
                    >
                      {{ page }}
                    </button>
                    }

                    <!-- Next Button -->
                    <button
                      (click)="goToNextPage()"
                      [disabled]="!hasNext"
                      class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700"
                    >
                      Next
                    </button>
                    
                  </div>
                </div>
                }
              </div>
            </div>
            }

            <!-- My Tasks Content -->
            @if (activeNavItem === 'my-tasks') {
            <div>
              @if (loadingTasks) {
              <div class="flex items-center justify-center p-8">
                <div
                  class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                ></div>
                <span class="ml-2 text-gray-600">Loading tasks...</span>
              </div>
              } @if (TasksComponent && !loadingTasks) {
              <ng-container
                [ngComponentOutlet]="TasksComponent"
                [ngComponentOutletInputs]="{ taskType: currentTaskType }"
              ></ng-container>
              }
            </div>
            }

            <!-- Calendar Content -->
            @if (activeNavItem === 'calendar') {
            <div>
              @if (loadingCalendar) {
              <div class="flex items-center justify-center p-8">
                <div
                  class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                ></div>
                <span class="ml-2 text-gray-600">Loading calendar...</span>
              </div>
              } @if (CalendarComponent && !loadingCalendar) {
              <ng-container
                [ngComponentOutlet]="CalendarComponent"
              ></ng-container>
              }
            </div>
            }

            <!-- Departments Content -->
            @if (activeNavItem === 'departments') {
            <div>
              <app-departments></app-departments>
            </div>
            }

            <!-- Members Content -->
            @if (activeNavItem === 'members') {
            <div>
              <app-members></app-members>
            </div>
            }

            <!-- Analytics Content (Only for Owners and Admins) -->
            @if (activeNavItem === 'analytics' &&
            canAccessAnalytics(currentUser$ | async)) {
            <div>
              @if (loadingAnalytics) {
              <div class="flex items-center justify-center p-8">
                <div
                  class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                ></div>
                <span class="ml-2 text-gray-600">Loading analytics...</span>
              </div>
              } @if (AnalyticsComponent && !loadingAnalytics) {
              <ng-container
                [ngComponentOutlet]="AnalyticsComponent"
              ></ng-container>
              } @if (!AnalyticsComponent && !loadingAnalytics) {
              <div class="text-center p-8">
                <p class="text-gray-600">
                  Analytics component failed to load. Please try refreshing the
                  page.
                </p>
              </div>
              }
            </div>
            }
          </div>
        </main>
      </div>
    </div>

    <!-- Profile Overlay -->
    <app-profile-overlay
      [isVisible]="isProfileOverlayVisible"
      (closeOverlay)="onProfileOverlayClose()"
    >
    </app-profile-overlay>

    <!-- Task Overlay -->
    <app-task-overlay
      [taskId]="selectedTaskId"
      [isVisible]="isTaskOverlayVisible"
      (closeOverlay)="onTaskOverlayClose()"
    >
    </app-task-overlay>

    <script>
      // Initialize Lucide icons
      document.addEventListener('DOMContentLoaded', function () {
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      });
    </script>
  </body>
</html>
