<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  [ngClass]="visible ? 'block' : 'hidden'"
>
  <div
    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-5xl relative overflow-y-auto max-h-[95vh] custom-scroll"
  >
    <button
      (click)="onCloseModal()"
      class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"
        ></path>
      </svg>
    </button>

    <div class="mb-8 border-b border-gray-200 dark:border-gray-700 pb-4">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
        Create New Task
      </h1>
      <p class="text-gray-600 dark:text-gray-400">
        Organize your {{ activeTab }} tasks efficiently
      </p>
    </div>

    <div
      class="bg-gray-100 rounded-lg p-1 mb-6 flex space-x-1 dark:bg-gray-900"
    >
      <button
        type="button"
        (click)="setActiveTab('work')"
        [ngClass]="{
          'bg-white dark:bg-gray-800 text-blue-600 shadow-md':
            activeTab === 'work',
          'text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white':
            activeTab !== 'work'
        }"
        class="flex-1 px-4 py-2 font-medium rounded-md transition-colors duration-200"
      >
        Work 
      </button>
      <button
        type="button"
        (click)="setActiveTab('personal')"
        [ngClass]="{
          'bg-white dark:bg-gray-800 text-blue-600 shadow-md':
            activeTab === 'personal',
          'text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white':
            activeTab !== 'personal'
        }"
        class="flex-1 px-4 py-2 font-medium rounded-md transition-colors duration-200"
      >
        Personal
      </button>
    </div>

    <form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
      <div class="space-y-8">
        <section
          class="grid grid-cols-1 lg:grid-cols-2 gap-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <div class="lg:col-span-2">
            <label
              for="title"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Task Title *
            </label>
            <input
              id="title"
              type="text"
              formControlName="title"
              placeholder="Enter task title..."
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            />
            <div
              *ngIf="isFieldInvalid('title')"
              class="mt-1 text-sm text-red-600 dark:text-red-400"
            >
              {{ getFieldError("title") }}
            </div>
          </div>
           
          <div *ngIf="activeTab === 'work'">
            <label
              for="department"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Department
            </label>
            <select
              id="department"
              formControlName="department"
              [disabled]="!canChangeDepartment"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            >
              <option *ngFor="let dept of departments" [value]="dept">
                {{ dept }}
              </option>
            </select>
          </div>

          <div class="lg:col-span-2">
            <label
              for="description"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              {{ activeTab === 'work' ? 'Description' : 'Notes' }}
            </label>
            <textarea
              id="description"
              formControlName="description"
              rows="4"
              placeholder="Provide a detailed description of the task..."
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            ></textarea>
          </div>

          <div>
            <label
              for="priority"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Priority
            </label>
            <select
              id="priority"
              formControlName="priority"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            >
              <option
                *ngFor="let priority of priorities"
                [value]="priority.value"
              >
                {{ priority.label }}
              </option>
            </select>
          </div>

          <div *ngIf="activeTab === 'work'">
            <label
              for="status"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Status
            </label>
            <select
              id="status"
              formControlName="status"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            >
              <option
                *ngFor="let status of statuses"
                [value]="status.value"
              >
                {{ status.label }}
              </option>
            </select>
          </div>

          <div *ngIf="activeTab === 'personal'">
            <label
              for="startDate"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Start Date *
            </label>
            <input
              id="startDate"
              type="date"
              formControlName="startDate"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            />
            <div
              *ngIf="isFieldInvalid('startDate')"
              class="mt-1 text-sm text-red-600 dark:text-red-400"
            >
              Start date is required.
            </div>
          </div>

          <div *ngIf="activeTab === 'personal'">
            <label
              for="startTime"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Start Time *
            </label>
            <input
              id="startTime"
              type="time"
              formControlName="startTime"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            />
            <div
              *ngIf="isFieldInvalid('startTime')"
              class="mt-1 text-sm text-red-600 dark:text-red-400"
            >
              Start time is required.
            </div>
          </div>
          
          <div *ngIf="activeTab === 'work' || (activeTab === 'personal' && !isRecurring)">
            <label
              for="dueDate"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              {{ activeTab === 'personal' ? 'End Date' : 'Due Date' }} *
            </label>
            <input
              id="dueDate"
              type="date"
              formControlName="dueDate"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            />
            <div
              *ngIf="isFieldInvalid('dueDate')"
              class="mt-1 text-sm text-red-600 dark:text-red-400"
            >
              {{ getFieldError("dueDate") }}
            </div>
          </div>

          <div *ngIf="activeTab === 'work' || activeTab === 'personal'">
            <label
              for="dueTime"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              {{ activeTab === 'personal' ? 'End Time' : 'Due Time' }} *
            </label>
            <input
              id="dueTime"
              type="time"
              formControlName="dueTime"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            />
            <div
              *ngIf="isFieldInvalid('dueTime')"
              class="mt-1 text-sm text-red-600 dark:text-red-400"
            >
              {{ getFieldError("dueTime") }}
            </div>
          </div>
          
          <div *ngIf="activeTab === 'personal'" class="flex items-center space-x-2">
            <input
              id="recurring"
              type="checkbox"
              formControlName="recurring"
              class="h-4 w-4 text-blue-600 rounded"
            />
            <label
              for="recurring"
              class="text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Daily recurring task
            </label>
          </div>
          
          <div *ngIf="activeTab === 'work'">
            <label
              for="assignee"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Assign to User
            </label>
            <select
              id="assignee"
              formControlName="assignee"
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            >
              <option *ngFor="let user of availableAssignees" [value]="user.id">
                {{ user.username }}
              </option>
            </select>
          </div>
          
        </section>

        <section
          class="space-y-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700"
        >
          <div>
            <label
              for="relatedTasks"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Related Tasks
            </label>
            <select
              id="relatedTasks"
              formControlName="relatedTasks"
              multiple
              class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all dark:bg-gray-900 dark:border-gray-700 dark:text-white"
            >
              <option
                *ngFor="let task of mockTasks"
                [value]="task.id"
              >
                {{ task.title }}
              </option>
            </select>
          </div>
          
          <div>
            <label
              for="links"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >Links</label
            >
            <div formArrayName="links">
              <div
                *ngFor="let link of links.controls; let i = index"
                [formGroupName]="i"
                class="flex gap-2 mb-2"
              >
                <input
                  type="url"
                  formControlName="url"
                  placeholder="Enter a URL"
                  class="flex-1 px-4 py-2 border rounded-lg dark:bg-gray-900 dark:border-gray-700 dark:text-white"
                />
                <button
                  type="button"
                  (click)="removeLink(i)"
                  class="text-red-500 hover:text-red-700 transition-colors"
                >
                  <svg
                    class="w-5 h-5"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M9 2a1 1 0 00-1 1v1H5a1 1 0 000 2h14a1 1 0 000-2h-3V3a1 1 0 00-1-1H9zm-3 8a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <button
              type="button"
              (click)="addLink()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Link
            </button>
          </div>

          <div>
            <label for="media" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Media (Files)
            </label>
            <div formArrayName="media">
              <div
                *ngFor="let mediaGroup of media.controls; let i = index"
                class="flex items-center gap-2 mb-2"
              >
                <input id="media" type="file"
                  (change)="onFileSelected($event, i)"
                  class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-all dark:file:bg-blue-900/20 dark:file:text-blue-300 dark:hover:file:bg-blue-900/30"
                />
                <span class="text-sm text-gray-500 dark:text-gray-400">{{ mediaGroup.value.name }}</span>
                <button
                  type="button"
                  (click)="removeMedia(i)"
                  class="text-red-500 hover:text-red-700 transition-colors"
                >
                  <svg
                    class="w-5 h-5"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M9 2a1 1 0 00-1 1v1H5a1 1 0 000 2h14a1 1 0 000-2h-3V3a1 1 0 00-1-1H9zm-3 8a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <button
              type="button"
              (click)="addMedia()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Media
            </button>
          </div>
        </section>
      </div>

      <div
        class="mt-8 px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg dark:bg-gray-900 dark:border-gray-700"
      >
        <div class="flex justify-between items-center flex-wrap gap-4">
          <button
            type="button"
            (click)="onCloseModal()"
            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
          >
            Cancel
          </button>
          <div class="flex gap-3">
            <button
              type="submit"
              [disabled]="taskForm.invalid"
              [class]="
                'px-6 py-2 text-white rounded-lg transition-colors ' +
                (taskForm.invalid
                  ? 'bg-gray-400 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700')
              "
            >
              Create Task
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>